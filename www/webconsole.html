<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<!-- If you're reading this from the Git source you'll see placeholder variable names, these
		will replaced in the file served to the browser with the relevant value. -->
		<title><<TITLE>></title>
		
		<!-- Our user interface is constructed with Bootstrap 5, including Popper 2. -->
		<link rel="stylesheet" href="bootstrap/5.1.3/css/bootstrap.min.css">
		<script src="popper/2.11.5/popper.min.js"></script>
		<script src="bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
		
		<!-- Favicon - code and different image sizes / formats are generated on demand server-side. -->
		<link rel="apple-touch-icon" sizes="180x180" href="<<FAVICONPATH>>apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="<<FAVICONPATH>>favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="<<FAVICONPATH>>favicon-16x16.png">
		<link rel="manifest" href="<<FAVICONPATH>>site.webmanifest">
		<link rel="mask-icon" href="<<FAVICONPATH>>safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		
		<!-- The Ace embedable Javascript code editor - see: https://github.com/ajaxorg/ace -->
		<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
		<!-- And the Ace "modelist" extension that lets us auto-set the edit mode for most well-known file types. -->
		<script src="ace/ext-modelist.js"></script>
		
		<!-- Our own Javascript library, which contains some handy utility functions. -->
		<script src="webconsole.js"></script>
		
		<script>
			mystartLoginPage = "<<MYSTARTLOGINPAGE>>"
			taskID = "<<TASKID>>";
			token = "<<TOKEN>>";
			permission = "<<PERMISSION>>"
			
			// We either call getTaskOutput every 2 seconds to provide updates to the user for a running
			// task, or keepAlive every 10 minutes (or thereabouts) to refresh a session's token.
			var intervalFunction;
			const keepAlivePeriod = 500000;
			const taskOutputUpdatePeriod = 2000;
			
			var displayAlerts = false;
			var currentEditFile = "";
			outputLine = 0;
			
			// A variable to reference the Ace text / code editor object.
			var aceEditor;
			var aceSessions = [];
			
			var aceModelist = ace.require("ace/ext/modelist");
			
			// Simply calls the keepAlive API method to make sure the session's token is refreshed.
			function keepAlive() {
				webconsole.APICall("keepAlive", {}, function(result) {});
			}
			
			// Run a Task.
			function runTask() {
				// First thing to do is disable the "Run" button so the user can't click it repeatadly.
				document.getElementById("runTaskButton").disabled = true;
				// Run the Task (if the Task is already running, this has no effect).
				webconsole.APICall("runTask", {}, function(result) {
					if (result == "OK") {
						document.getElementById("runTaskButton").innerHTML = "<span class='spinner-border spinner-border-sm' role='status'></span> Running...";
						document.getElementById("taskAlerts").innerHTML = "";
						document.getElementById("taskOutput").innerHTML = "";
						document.getElementById("taskResults").innerHTML = "";
						outputLine = 0;
						
						// If the call returns "OK" then the task is running, subsequent calls to getTaskOutput will return the console output of the Task as it runs.
						displayAlerts = true;
						updateTaskOutput();
						clearInterval(intervalFunction);
						intervalFunction = setInterval(updateTaskOutput, taskOutputUpdatePeriod);
					} else {
						// If runTask didn't return "OK" then it returned an error, which we display in red for the user.
						document.getElementById("taskAlerts").innerHTML = "<div style='color:red'>" + result + "</div>";
						document.getElementById("runTaskButton").disabled = false;
					}
				});
			}
			
			// Called periodically (period defined by constant at start of file) after a Task has been started to update information for the user.
			function updateTaskOutput() {
				webconsole.APICall("getTaskOutput", {"line":outputLine}, function(result) {
					for (value of result.split("\n")) {
						if (value.trim() != "") {
							// If the Task has finished, reset the "Run" button state.
							if (value.trim() == "ERROR: REDIRECT" || value.trim() == "ERROR: EOF") {
								clearInterval(intervalFunction);
								intervalFunction = setInterval(keepAlive, keepAlivePeriod);
								document.getElementById("runTaskButton").innerHTML = "Run";
								document.getElementById("runTaskButton").disabled = false;
								document.getElementById("taskProgress").innerHTML = "";
								
								// If there's a "www" folder present in the Task's folder after the Task has run, that's treated as the result of the Task,
								// which is shown to the user. If the user has "view" or "run" permissions they are redirected to the result page. If they have
								// "edit" permissions they are shown the result in a expanded collapse section so, they don't have to keep switching between the
								// edit page and the results page as they edit code.
								if (value.trim() == "ERROR: REDIRECT") {
									if (displayAlerts == true) {
										if (permission == "E") {
											document.getElementById("resultIframe").contentWindow.location.reload();
											var bsCollapse = new bootstrap.Collapse(document.getElementById("collapseFive"), {
												toggle: true
											});
										} else {
											window.location.href = window.location.href.split("?")[0].slice(0, -4) + taskID + "/";
										}
									}
								}
							} else {
								// Include formatting.js.
								if (value.toLowerCase().startsWith("progress:")) {
									// If a string begins with "Progress: ", interpret the following number as a
									// percentage completion value, and update the progress bar accordingly.
									progressBarName = value.substring(value.indexOf(":")+1, value.lastIndexOf(" ")).trim();
									progressBarValue = value.substring(value.lastIndexOf(" ")+1, value.length).replace("%","").trim();
									document.getElementById("taskProgress").innerHTML = progressBarName + ": " + progressBarValue + "% <div class='progress'><div class='progress-bar' role='progressbar' style='width:" + progressBarValue + "%' aria-valuenow='" + progressBarValue + "' aria-valuemin='0' aria-valuemax='100'></div></div>";
								} else {
									// Otherwise, display the line as a message for the user.
									document.getElementById("taskOutput").innerHTML = document.getElementById("taskOutput").innerHTML + value + "\n";
								}
								outputLine = outputLine + 1;
							}
						}
					}
				});
			}
			
			// Flip the "Show/Hide Output" button.
			function flipOutputMessage() {
				if (document.getElementById("showOutputButton").innerHTML = "Show output") {
					document.getElementById("showOutputButton").innerHTML = "Hide output";
				} else {
					document.getElementById("showOutputButton").innerHTML = "Show output";
				}
			}
			
			// Copy the webhook URL to the clipboard for the user.
			function copyAutomationURL() {
				copyText = document.getElementById("automationLink")
				copyText.select();
				//copyText.setSelectionRange(0, 99999); // For mobile devices.
				document.execCommand("copy");
			}
			
			// Copy the CURL command to the clipboard for the user.
			function copyCURLCommand() {
				copyText = document.getElementById("CURLCommand")
				copyText.select();
				document.execCommand("copy");
			}
			
			function downloadGitHubActionFile() {
				alert("Functionality goes here.");
			}
			
			// Copy the CURL command to the clipboard for the user.
			function copyMystartLogin() {
				copyText = document.getElementById("mystartLogin")
				copyText.select();
				document.execCommand("copy");
			}
			
			// Get the given file contents from the server and place it in the file edit panel.
			function editFile(theFilename) {
				currentEditFile = theFilename;
				webconsole.APICall("getEditableFileContents", {"filename":theFilename}, function(result) {
					if (aceEditor == null) {
						aceEditor = ace.edit("editFileBox");
					}
					if (!(theFilename in aceSessions)) {
						aceSessionMode = "ace/mode/text";
						if (theFilename == "config.txt") {
							aceSessionMode = "ace/mode/yaml";
						} else {
							aceSessionMode = aceModelist.getModeForPath(theFilename).mode;
						}
						aceSessions[theFilename] = ace.createEditSession(result, aceSessionMode);
						aceSessions[theFilename].on("change", function(delta) {
							document.getElementById("saveFileButton").disabled = false;
						});
					}
					aceEditor.setSession(aceSessions[theFilename]);
					if (aceSessions[theFilename].getUndoManager().isClean()) {
						document.getElementById("saveFileButton").disabled = true;
					} else {
						document.getElementById("saveFileButton").disabled = false;
					}
					if (theFilename == "log.txt") {
						aceEditor.setReadOnly(true);
					} else {
						aceEditor.setReadOnly(false);
					}
				});
			}
			
			// Save the current file being edited in the edit file panel.
			function saveFile() {
				webconsole.APICall("saveFile", {"filename":currentEditFile, "contents":aceEditor.session.getValue()}, function(result) {
					if (result == "OK") {
						document.getElementById("saveFileButton").disabled = true;
					} else {
						alert(result);
					}
				});
			}
			
			// Return to the Home page.
			function returnHome() {
				webconsole.doAction("POST", window.location.href.replace("/view", "/").replace("/run", "/"), false, {"token":"<<TOKEN>>"}, true);
			}
			
			// Called when the document is first loaded and ready.
			function pageReady() {
				if (taskID == "/" && window.location.href.includes("/view?")) {
					webconsole.doAction("POST", window.location.href.split("/view?")[0], false, {"token":token}, false)
				}
				
				// Set up the keepAlive call.
				intervalFunction = setInterval(keepAlive, keepAlivePeriod);
				
				pageURL = window.location.href.split("?")[0]
				// Set the webhook value for the user - the "run" API call for this Task, handy for services such as IFTTT and Zapier.
				document.getElementById("automationLink").value = pageURL.slice(0, pageURL.lastIndexOf("/")) + "/api/runTask?taskID=" + taskID;
				// Set the CURL command webhook value for the user - the "run" API call for this Task, handy for calling from the command line or a cron job / Windows schedualed task.
				document.getElementById("CURLCommand").value = "curl " + pageURL.slice(0, pageURL.lastIndexOf("/")) + "/api/runTask?taskID=" + taskID;
				// If appropriate (i.e. if this Task / server in general is set up to use Mystart.Online for logins), set the MyStart.Online Login URL value for the user and display it.
				if (mystartLoginPage != "") {
					mystartURL = "https://dev.mystart.online/page/" + mystartLoginPage + "?taskID=" + taskID;
					document.getElementById("mystartLogin").value = mystartURL;
					document.getElementById("mystartLoginLink").href = mystartURL;
					document.getElementById("mystartBlock").style.display = "block";
				}
				// If the URL includes "run" rather than "view", run the Task right away - handy for some users.
				if (pageURL.endsWith("/run")) {
					runTask();
				} else {
					// If the Task is already running call the "runTask" function to set up the interface.
					webconsole.APICall("getTaskRunning", {}, function(result) {
						if (result == "YES") {
							runTask();
						} else {
							// If the Task isn't actually running at the moment, a call to updateTaskOutput will get the previous
							// output and populate the output tab with it.
							updateTaskOutput();
						}
					});
				}
				if (permission == "E") {
					document.getElementById("editBlock").style.display = "block";
					webconsole.APICall("getEditableFileList", {}, function(result) {
						JSON.parse(result).forEach(function(editableFile) {
							editableFileList = document.getElementById("editFileList");
							editableFileList.innerHTML = editableFileList.innerHTML + "<div><a href=\"#\" onclick=\"editFile('" + editableFile + "'); return false;\">" + editableFile + "</a></div>";
						});
					});
					document.getElementById("saveFileButton").disabled = true;
					
					// If the user has "edit" permisions they see any result produced in a "result" tab rather than be redirected as they would with "view" or "run" permissions.
					document.getElementById("resultIframe").src = window.location.href.split("?")[0].slice(0, -4) + taskID + "/";
					document.getElementById("resultBlock").style.display = "block";
				}
			}
		</script>
	</head>
	<body onload="pageReady()">
		<form id="actionForm" action="" method=""></form>
		<div class="row">
			<div class="col-sm-1 text-center align-self-center"></div>
			<div class="col-sm-10 text-center align-self-center">
				<!-- The main title block. -->
				<div class="p-2 rounded m-3" style="background-color:LightSteelBlue">
					<h1 class="text-center" id="taskTitle"><<TITLE>></h1>
				</div>
				
				<!-- The main "alerts" section where the most important output for the user goes. -->
				<div class="p-2 rounded m-3" style="background-color:LightSteelBlue">
					<div class="m-4" id="taskDescription"><<DESCRIPTION>></div>
					<button class="btn btn-success" type="button" id="runTaskButton" onclick="runTask()">Run</button>
					<div id="taskProgress"></div>
					<div id="taskAlerts"></div>
					<div id="taskResults"></div>
				</div>
				
				<div class="accordion" id="accordionOutput">
					<div class="accordion-item">
						<h2 class="accordion-header" id="headingOutput">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOutput" aria-expanded="false" aria-controls="collapseOutput">
								Output
							</button>
						</h2>
						<div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOutput" data-bs-parent="#accordionOutput">
							<div class="accordian-body font-monospace text-start" style="white-space:pre-line" id="taskOutput"></div>
						</div>
					</div>
				</div>
				<div class="accordion" id="accordionMain">
					<div class="accordion-item">
						<h2 class="accordion-header" id="headingTwo">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
								Automation
							</button>
						</h2>
						<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionMain">
							<div class="accordion-body text-end">
								<div>
									<a href="https://ifttt.com/home" target="_blank"><img src="logos/IFTTT.svg" alt="IFTTT Logo" width="32" height="32"></a>
									<a href="https://zapier.com/app/dashboard" target="_blank"><img src="logos/zapier.svg" alt="Zapier Logo" width="32" height="32"></a>
									Automation URL: <input type="text" id="automationLink" value="https://" readonly/>
									<button type="button" class="btn btn-default" aria-label="Copy Automation URL" onclick="copyAutomationURL()">
										<img src="bootstrap-icons/1.8.1/stickies.svg" alt="Copy Automation URL" width="32" height="32">
									</button>
								</div>
								<div>
									<a href="https://curl.se/docs/manpage.html" target="_blank"><img src="logos/curl.svg" alt="curl Logo" width="32" height="32"></a>
									curl command: <input type="text" id="CURLCommand" value="https://" readonly/>
									<button type="button" class="btn btn-default" aria-label="Copy CURL command" onclick="copyCURLCommand()">
										<img src="bootstrap-icons/1.8.1/stickies.svg" alt="Copy CURL command" width="32" height="32">
									</button>
								</div>
								<div>
									<a href="https://github.com/features/actions" target="_blank"><img src="logos/github.svg" alt="GitHub Logo" width="32" height="32"></a>
									GitHub Action file:
									<button type="button" class="btn btn-default" aria-label="Download GitHub Action file" onclick="downloadGitHubActionFile()">
										<img src="bootstrap-icons/1.8.1/arrow-down-circle.svg" alt="Download GitHub Action file" width="32" height="32">
									</button>
								</div>
								<div id="mystartBlock" style="display:none">
									<a href="https://mystart.online" target="_blank"><img src="logos/mystart.svg" alt="Mystart.Online Logo" width="32" height="32"></a>
									MyStart.Online Login URL: <input type="text" id="mystartLogin" value="https://" readonly/>
									<a id="mystartLoginLink" class="btn btn-default" aria-label="Open MyStart.Online Login URL" href="#" role="button">
										<img src="bootstrap-icons/1.8.1/arrow-right-circle.svg" alt="Open MyStart.Online Login URL" width="32" height="32">
									</a>
									<button type="button" class="btn btn-default" aria-label="Copy MyStart.Online Login URL" onclick="copyMystartLogin()">
										<img src="bootstrap-icons/1.8.1/stickies.svg" alt="Copy MyStart.Online Login URL" width="32" height="32">
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="accordion-item" id="editBlock" style="display:none">
						<h2 class="accordion-header" id="headingThree">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
								Edit
							</button>
						</h2>
						<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionMain">
							<div class="accordian-body text-start">
								<div class="row">
									<div class="col-sm-3" id="editFileList">
									</div>
									<div class="col-sm-9" id="editFilePanel">
										<div id="editFileBox" style="position:relative; width:100%; height:500px;"></div>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-12">
										<button class="btn btn-success" type="button" id="saveFileButton" onclick="saveFile()">Save</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="accordion-item" id="backupBlock" style="display:none">
						<h2 class="accordion-header" id="headingFour">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
								Backup
							</button>
						</h2>
						<div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionMain">
							<div class="accordian-body text-start">
								<div class="row">
									<button class="btn btn-success" type="button" id="backupButton" onclick="downloadBackup()">Backup</button>
								</div>
							</div>
						</div>
					</div>
					<div class="accordion-item" id="resultBlock" style="display:none">
						<h2 class="accordion-header" id="headingFive">
							<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
								Result
							</button>
						</h2>
						<div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#accordionMain">
							<div class="accordian-body text-start">
								<iframe id="resultIframe" title="Result" style="width:100%; height:84vh;"></iframe>
							</div>
						</div>
					</div>
				</div>
				
				<!-- The bottom of the page. -->
				<div class="row">
					<div class="col-sm-11 align-self-center"></div>
					<div class="col-sm-1 align-self-end">
						<!-- The Home button. -->
						<a id="homeButton" class="btn btn-primary" role="button" onclick="returnHome()">Home</a>
					</div>
				</div>
			</div>
			
			<div class="col-sm-1 text-center align-self-center"></div>
		</div>
	</body>
</html>
